---
title: "California Housing"
output: html_document
---

<style type="text/css">
.title {
  display: none;
}

</style>

<div class="row" style="padding-top: 0px;"> 
<div class="col-sm-6">
```{r}
library(tidyverse)
library(tidycensus)
library(ggplot2)
library(spData)
library(sf)
library(rcartocolor)
library(cowplot)
library(tigris)
options(tigris_use_cache = TRUE)


```

```{r Load ACS}
AllACSVariables <- load_variables(year = 2019, 
                                  dataset = "acs5", 
                                  cache = TRUE)

ACSYears <- lst(2009, 2019)

CaliforniaPopulations <- map_dfr(
  ACSYears, 
  ~get_acs(
    geography = "county",
    variables = "B01003_001",
    year = .x,
    state = "CA",
    survey = "acs5",
    geometry = FALSE
  ),
  .id = "year") %>%
  mutate(County.Name = str_sub(NAME,end = -13))

CaliforniaPopulations <- subset(CaliforniaPopulations, select = -c(moe))

CaliforniaGeography <- get_acs(
  geography = "county",
  variables = "B01003_001",
  year = 2019,
  state = "CA",
  survey = "acs5",
  geometry = TRUE
) %>%
  mutate(County.Name = str_sub(NAME,end = -13))

CaliforniaGeography <- subset(CaliforniaGeography, select = -c(estimate, moe, variable))



```

```{r Chunk 2}
CaliforniaPopulationsSpread <- CaliforniaPopulations %>% spread(year, estimate)
CaliforniaPopulationsSpread$Growth <- (CaliforniaPopulationsSpread$"2019" - CaliforniaPopulationsSpread$"2009")/ CaliforniaPopulationsSpread$"2009"

CaliforniaPopulationsSpread$Change <- CaliforniaPopulationsSpread$"2019" - CaliforniaPopulationsSpread$"2009"

CaliforniaForMap <- merge(CaliforniaGeography, CaliforniaPopulationsSpread)
```


```{r Chunk 3}
ggplot() +
  geom_sf(data = CaliforniaForMap, aes(fill = Growth), color = 'black') +
  scale_fill_distiller(palette = "PRGn", 
                       direction = 1) +
  theme_classic()


hist(CaliforniaForMap$Growth)

```


```{r Chunk 4}

CaliforniaPermits <- read.csv('CaliforniaPermits.csv') %>%
  mutate(NumUnits = as.numeric(gsub(",","",Total.Units)))

```

```{r Chunk 5}

CaliforniaPermitsClean <- CaliforniaPermits %>% filter(Survey.Date >= 2009 & Survey.Date <= 2019)

CaliforniaPermitsSummary <- CaliforniaPermitsClean %>%
  group_by(County.Name) %>%
  summarize(NumPermits = sum(NumUnits))

```

```{r Chunk 6}

CaliforniaGrowthToPermit <- merge(CaliforniaPermitsSummary, CaliforniaForMap)

CaliforniaGrowthToPermit$ChangeRatio <- CaliforniaGrowthToPermit$Change/CaliforniaGrowthToPermit$NumPermits

ggplot(data = CaliforniaGrowthToPermit, aes(fill = ChangeRatio, geometry = geometry)) +
  geom_sf(color = 'black') +
  scale_fill_distiller(palette = "PRGn", 
                       direction = 1, 
                       lim = c(-10, 10)) +
  theme_classic()

```


```{r Chunk 7}

ACSYears <- lst(2009, 2019)

MedianRent <- map_dfr(
  ACSYears, 
  ~get_acs(
    geography = "county",
    variables = "B25059_001",
    year = .x,
    state = "CA",
    survey = "acs5",
    geometry = FALSE
  ),
  .id = "year") %>%
  mutate(County.Name = str_sub(NAME,end = -13))

MedianRent <- subset(MedianRent, select = -c(moe))

MedianRentSpread <- MedianRent %>% spread(year, estimate)
MedianRentSpread$RentGrowth <- (MedianRentSpread$"2019" - MedianRentSpread$"2009")/ MedianRentSpread$"2009"

MedianRentSpread$RentChange <- MedianRentSpread$"2019" - MedianRentSpread$"2009"

MedianRentSummary <- MedianRentSpread %>%
  group_by(County.Name) %>%
  summarize(RentGrowth = RentGrowth,
            RentChange = RentChange)

RentMapPermits <- merge(MedianRentSummary, CaliforniaGrowthToPermit) 

ggplot(RentMapPermits %>% filter(ChangeRatio > -20), 
       aes(x = ChangeRatio, y= log(RentChange))) +
  geom_point()

ggplot(RentMapPermits %>% 
         filter(ChangeRatio > 0), 
       aes(x = ChangeRatio)) + 
  geom_histogram()

AboveZeroRatios <- RentMapPermits %>% filter(ChangeRatio >= 0 ) %>%
  mutate(RatioTile = ntile(ChangeRatio, 2))

ggplot(AboveZeroRatios, aes(x = RatioTile, y = RentChange, group = RatioTile)) +
  geom_boxplot() +
  theme_minimal()

```


## Labor Force ##

```{r Chunk 8}

LaborForce <- read.csv('Local_Area_Unemployment_Statistics__LAUS_.csv') %>%
  mutate(
    AreaType = Ã¯..Area.Type,
    SeasonallyAdjusted = Seasonally.Adjusted..Y.N.
  )

LaborForceClean <- LaborForce %>% 
  filter(AreaType == 'County') %>%
  filter(Year == 2009 | Year == 2019) %>%
  filter(Month == 'January') %>%
  filter(SeasonallyAdjusted == 'N') %>%
  mutate(County.Name = Area.Name,
         Labor.Force = as.numeric(gsub(",","",Labor.Force)))%>%
  subset(select = c(County.Name, Year, Labor.Force)) %>%
  spread(Year, Labor.Force) 

LaborForceClean$LaborGrowth <- LaborForceClean$"2019" - LaborForceClean$"2009"

LaborPermits <- merge(LaborForceClean, CaliforniaPermitsSummary)

LaborPermits$LaborPermitRatio <- LaborPermits$LaborGrowth/LaborPermits$NumPermits

LaborPermits <- LaborPermits %>%
  subset(select = c(County.Name, LaborGrowth, NumPermits, LaborPermitRatio))

LaborPermits <- merge(LaborPermits, CaliforniaGeography)

ggplot(LaborPermits, aes(fill = LaborPermitRatio, geometry = geometry)) +
  geom_sf() +
  scale_fill_distiller(palette = "PRGn", 
                       direction = 1, 
                       lim = c(-8.5, 8.5))

LaborPermits <- merge(LaborPermits, RentMapPermits) 
LaborPermitTile <- LaborPermits %>%
  mutate(LaborGroup = ifelse(LaborPermitRatio > 1, 2, 1),
         LaborTile = ntile(LaborPermitRatio,2))

plot(LaborPermitTile$LaborPermitRatio, LaborPermitTile$RentChange)

ggplot(LaborPermitTile, aes(x = as.factor(LaborGroup), y = (RentChange))) + 
  geom_boxplot()

```


```{r Chunk 9 }

us_states = states(cb = FALSE, class = "sf")

ca_counties = counties("CA")

us_states = subset(us_states, 
                   !NAME %in% c(
                     "United States Virgin Islands",
                     "Commonwealth of the Northern Mariana Islands",
                     "Guam",
                     "American Samoa",
                     "Puerto Rico",
                     "Alaska",
                     "Hawaii"
                   ))

ky_districts_2163 = st_transform(ca_counties, crs = 4326) #2163
us_states_2163 = st_transform(us_states, crs = 4326)

ky_districts_2163_bb = st_as_sfc(st_bbox(ky_districts_2163))
ky_districts_2163_bb = st_buffer(ky_districts_2163_bb, dist = 10000)

ky_districts_2163$values = runif(nrow(ky_districts_2163))

ggm3 = ggplot() + 
  geom_sf(data = us_states_2163, fill = "white", size = 0.2) + 
  geom_sf(data = ky_districts_2163_bb, fill = NA, color = "blue", size = 1.2) +
  theme_void()

ggm3

ggm4 = ggplot() + 
  geom_sf(data = us_states_2163, fill = "#F5F5DC") +
  geom_sf(data = ky_districts_2163, aes(fill = values), color = 'black') +
  scale_fill_carto_c(palette = "Geyser") +
  theme_void() +
  theme(legend.position = c(0.5, 0.07),
        legend.direction = "horizontal",
        legend.key.width = unit(10, "mm"),
        plot.background = element_rect(fill = "#BFD5E3")) +
  coord_sf(xlim = st_bbox(ky_districts_2163_bb)[c(1, 3)],
           ylim = st_bbox(ky_districts_2163_bb)[c(2, 4)])

ggm4

```

</div>
<div class="col-sm-6">


</a>
</div>


</a>
</div>
